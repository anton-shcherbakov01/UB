<clickhouse>
    <!-- 
        ВАЖНО: Добавляем вывод логов в консоль (stdout), 
        чтобы видеть ошибки запуска в docker logs 
    -->
    <logger>
        <level>information</level>
        <console>1</console>
    </logger>

    <!-- Слушаем только IPv4 (убирает ошибки DNS error на серверах без IPv6) -->
    <listen_host>0.0.0.0</listen_host>

    <!-- ОПТИМИЗАЦИЯ ПАМЯТИ ДЛЯ 8GB (выделенных под ClickHouse) -->
    
    <!-- 1. Максимум памяти для процесса ClickHouse (8GB) 
         8 * 1024 * 1024 * 1024 = 8589934592
    -->
    <max_server_memory_usage>8589934592</max_server_memory_usage>
    
    <!-- 2. Кэш "засечек" (индексов). Увеличиваем пропорционально до 512MB -->
    <mark_cache_size>536870912</mark_cache_size>
    
    <!-- 3. Кэш разжатых данных. Увеличиваем пропорционально до 512MB -->
    <uncompressed_cache_size>536870912</uncompressed_cache_size>

    <!-- 4. Лимит одновременных запросов (увеличиваем, так как ресурсов стало больше) -->
    <max_concurrent_queries>40</max_concurrent_queries>
    
    <!-- 5. Фоновые процессы 
         Увеличиваем пул потоков до 8, так как памяти стало больше.
         Это поможет быстрее разгребать очередь слияний (merges).
    -->
    <background_pool_size>8</background_pool_size>
    <background_merges_mutations_concurrency_ratio>2</background_merges_mutations_concurrency_ratio>

    <!-- 
        6. Настройки MergeTree
        Так как background_pool_size увеличен до 8, 
        мы можем позволить себе чуть большие резервы для мутаций и оптимизаций.
    -->
    <merge_tree>
        <!-- Резерв для мутаций (подняли с 2 до 4) -->
        <number_of_free_entries_in_pool_to_execute_mutation>4</number_of_free_entries_in_pool_to_execute_mutation>
        
        <!-- Резерв для оптимизации партиций (подняли с 2 до 4) -->
        <number_of_free_entries_in_pool_to_execute_optimize_entire_partition>4</number_of_free_entries_in_pool_to_execute_optimize_entire_partition>
    </merge_tree>
</clickhouse>