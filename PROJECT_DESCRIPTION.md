# Описание проекта UB

## Общая информация

Проект **UB** — это микросервис для парсинга и анализа товаров с маркетплейса Wildberries. Проект состоит из backend части на Python (FastAPI) и frontend части на React для Telegram Web App.

## Архитектура проекта

Проект построен по микросервисной архитектуре с разделением на следующие компоненты:
- **Backend API** (FastAPI) — REST API для получения данных о товарах
- **Parser Service** — сервис парсинга данных с Wildberries
- **Analysis Service** — сервис расчета метрик и аналитики
- **Auth Service** — сервис аутентификации через Telegram Web App
- **Frontend** (React) — пользовательский интерфейс для Telegram

---

## Структура файлов проекта

### 1. `main.py` — Главный файл FastAPI приложения

**Назначение:** Точка входа в backend приложение, содержит FastAPI сервер и маршруты API.

**Основные компоненты:**
- Инициализация FastAPI приложения
- Настройка CORS для кросс-доменных запросов
- Интеграция сервисов (parser_service, analysis_service, auth_service)
- REST API endpoint: `GET /api/analyze/{sku}`

**Функциональность:**
- Принимает запросы на анализ товара по артикулу (SKU)
- Опциональная аутентификация через Telegram (закомментирована)
- Вызывает parser_service для получения данных
- Вызывает analysis_service для расчета метрик
- Возвращает результат в JSON формате

**Зависимости:**
- `fastapi` — веб-фреймворк
- `uvicorn` — ASGI сервер
- `python-dotenv` — загрузка переменных окружения
- Локальные модули: `parser_service`, `analysis_service`, `auth_service`

**Переменные окружения:**
- `BOT_TOKEN` — токен Telegram бота для аутентификации

---

### 2. `parser_service.py` — Сервис парсинга Wildberries

**Назначение:** Микросервис для парсинга данных о товарах с сайта Wildberries с использованием Selenium.

**Основные классы:**
- `SeleniumWBParser` — основной класс парсера

**Ключевые методы:**

#### `__init__(self)`
Инициализация парсера с загрузкой настроек из переменных окружения:
- `HEADLESS` — режим браузера (headless/visible)
- `PROXY_USER` — пользователь прокси
- `PROXY_PASS` — пароль прокси
- `PROXY_HOST` — хост прокси сервера
- `PROXY_PORT` — порт прокси сервера

#### `_create_proxy_auth_extension(self, user, pw, host, port)`
Создает расширение для браузера Edge для авторизации прокси с динамической ротацией сессий:
- Генерирует уникальный ID сессии для каждой сессии
- Создает ZIP архив с расширением браузера
- Настраивает прокси с авторизацией

#### `_init_driver(self)`
Инициализация Selenium WebDriver для Edge:
- Настройка headless режима
- Установка прокси расширения
- Подавление логов и предупреждений
- Настройка User-Agent
- Скрытие признаков автоматизации

#### `_extract_price(self, driver, selector)`
Извлечение цены из элемента страницы по CSS селектору:
- Поиск элементов через селектор
- Извлечение текста через JavaScript
- Очистка от нечисловых символов
- Возврат целочисленного значения

#### `get_product_data(self, sku: int)`
Основной метод парсинга товара:
- До 3 попыток получения данных
- Обход блокировок Kaspersky через ротацию IP
- Динамическое ожидание загрузки цен (до 60 секунд)
- Использование множественных CSS селекторов для поиска цен
- Fallback метод глубокого сканирования при отсутствии цен
- Извлечение данных о бренде и названии товара
- Возврат структурированных данных о товаре

**Структура возвращаемых данных:**
```python
{
    "id": int,              # Артикул товара
    "name": str,            # Название товара
    "brand": str,           # Бренд
    "prices": {
        "wallet_purple": int,    # Цена с оплатой кошельком
        "standard_black": int,   # Обычная цена
        "base_crossed": int      # Базовая цена (зачеркнутая)
    },
    "status": str,          # "success" или "error"
    "attempts": int         # Количество попыток
}
```

**Особенности:**
- Ротация прокси сессий для обхода блокировок
- Обработка различных селекторов цен
- Устойчивость к блокировкам антибот систем
- Логирование всех операций

---

### 3. `auth_service.py` — Сервис аутентификации

**Назначение:** Сервис для валидации данных инициализации Telegram Web App.

**Основные классы:**
- `AuthService` — класс для работы с аутентификацией

**Методы:**

#### `__init__(self, bot_token: str)`
Инициализация сервиса с токеном бота Telegram.

#### `validate_init_data(self, init_data: str) -> bool`
Валидация данных инициализации Telegram Web App:
- Парсинг query string параметров
- Извлечение и проверка хеша
- Генерация секретного ключа через HMAC-SHA256
- Сравнение вычисленного и полученного хеша
- Возврат `True` если данные валидны, `False` иначе

**Безопасность:**
- Использует HMAC-SHA256 для проверки подлинности
- Следует официальному протоколу Telegram Web App

---

### 4. `analysis_service.py` — Сервис анализа данных

**Назначение:** Сервис для расчета метрик и аналитики на основе данных о товаре.

**Основные классы:**
- `AnalysisService` — класс для расчета метрик

**Методы:**

#### `calculate_metrics(raw_data: dict)`
Статический метод для расчета метрик товара:

**Входные данные:**
- `raw_data` — словарь с данными о товаре из parser_service

**Возвращаемые метрики:**
```python
{
    "wallet_benefit": int,              # Выгода при оплате кошельком (разница)
    "total_discount_percent": float,    # Общий процент скидки
    "is_favorable": bool                # Флаг выгодности (скидка > 45%)
}
```

**Логика расчета:**
- `wallet_benefit` = стандартная цена - цена кошельком (если положительная)
- `total_discount_percent` = (базовая цена - цена кошельком) / базовая цена × 100
- `is_favorable` = true, если скидка превышает 45%

---

### 5. `App.jsx` — React компонент фронтенда

**Назначение:** Пользовательский интерфейс для Telegram Web App для взаимодействия с API.

**Технологии:**
- React (функциональный компонент с хуками)
- Lucide React — иконки
- Tailwind CSS (inline стили)

**Основные функции:**

#### `useState` хуки:
- `sku` — состояние поля ввода артикула
- `loading` — состояние загрузки
- `data` — состояние полученных данных
- `error` — состояние ошибки

#### `useEffect`
Инициализация Telegram Web App при монтировании компонента:
- Вызов `Telegram.WebApp.ready()`
- Расширение окна приложения

#### `handleAnalyze()`
Асинхронная функция для запроса данных:
- Валидация введенного артикула
- Отправка GET запроса на `/api/analyze/{sku}`
- Передача данных Telegram в заголовке `X-TG-Data`
- Обработка успешного ответа и ошибок
- Управление состояниями loading/error/data

**UI компоненты:**
- Заголовок с логотипом и названием "WB Monitor"
- Поле ввода артикула с иконкой поиска
- Кнопка "Получить цены" с индикатором загрузки
- Блок отображения ошибок
- Карточка товара с:
  - Брендом и названием
  - Бейджем "Выгодно" (если скидка > 45%)
  - Ценой кошельком (фиолетовый блок)
  - Обычной ценой (серый блок)
  - Базовой ценой (зачеркнутая)

**Стилизация:**
- Современный дизайн с градиентами и тенями
- Адаптивная верстка
- Анимации и переходы
- Цветовая схема: индиго, фиолетовый, серый

---

### 6. `package.json` — Конфигурация Node.js зависимостей

**Назначение:** Файл конфигурации npm для управления зависимостями фронтенда.

**Зависимости:**
- `lucide-react` (^0.562.0) — библиотека иконок для React

**Примечание:** Проект использует минимальный набор зависимостей для фронтенда.

---

## Поток данных в приложении

```
1. Пользователь вводит артикул в Telegram Web App (App.jsx)
   ↓
2. Отправка GET запроса на /api/analyze/{sku} с заголовком X-TG-Data
   ↓
3. FastAPI сервер (main.py) получает запрос
   ↓ (опционально)
4. AuthService валидирует данные Telegram (закомментировано)
   ↓
5. ParserService (parser_service.py) получает данные:
   - Инициализирует Selenium WebDriver с прокси
   - Открывает страницу товара на Wildberries
   - Обходит блокировки (Kaspersky)
   - Извлекает цены через множественные методы
   - Возвращает структурированные данные
   ↓
6. AnalysisService (analysis_service.py) рассчитывает метрики:
   - Выгода кошельком
   - Процент скидки
   - Флаг выгодности
   ↓
7. Возврат JSON ответа клиенту
   ↓
8. Отображение данных в React компоненте (App.jsx)
```

---

## Переменные окружения

Проект использует файл `.env` (не включен в репозиторий) со следующими переменными:

### Backend:
- `BOT_TOKEN` — токен Telegram бота для аутентификации
- `HEADLESS` — режим браузера ("True" или "False")
- `PROXY_USER` — имя пользователя прокси
- `PROXY_PASS` — пароль прокси
- `PROXY_HOST` — хост прокси сервера
- `PROXY_PORT` — порт прокси сервера

---

## Технологический стек

### Backend:
- **Python 3.9+**
- **FastAPI** — современный веб-фреймворк
- **Uvicorn** — ASGI сервер
- **Selenium** — автоматизация браузера
- **Edge WebDriver** — драйвер для Microsoft Edge
- **python-dotenv** — управление переменными окружения
- **webdriver-manager** — автоматическое управление драйверами

### Frontend:
- **React** — библиотека для создания UI
- **Lucide React** — иконки
- **Tailwind CSS** — utility-first CSS фреймворк (inline)

### Инфраструктура:
- **Telegram Web App** — платформа для запуска приложения
- **Прокси серверы** — для обхода блокировок

---

## Особенности реализации

### Обход блокировок:
1. **Ротация прокси сессий** — каждый запрос использует уникальный ID сессии
2. **Динамическое ожидание** — адаптивное ожидание загрузки контента
3. **Множественные селекторы** — использование различных CSS селекторов для поиска цен
4. **Fallback методы** — глубокое сканирование страницы при неудаче основных методов
5. **Скрытие автоматизации** — настройка User-Agent и параметров браузера

### Надежность:
- Повторные попытки при ошибках (до 3 раз)
- Обработка различных типов ошибок
- Логирование всех операций
- Graceful degradation при отсутствии данных

### Безопасность:
- Валидация данных Telegram через HMAC
- CORS настройки для контроля доступа
- Обработка ошибок без утечки чувствительной информации

---

## Запуск проекта

### Backend:
```bash
# Активация виртуального окружения
venv\Scripts\activate

# Установка зависимостей (если требуется)
pip install fastapi uvicorn selenium webdriver-manager python-dotenv

# Запуск сервера
python main.py
```

Сервер запустится на `http://0.0.0.0:8000`

### Frontend:
```bash
# Установка зависимостей
npm install

# Сборка проекта (требуется настройка сборки)
# Или использование через CDN/Telegram Web App
```

---

## API Endpoints

### GET `/api/analyze/{sku}`

**Описание:** Получение данных и метрик о товаре по артикулу.

**Параметры:**
- `sku` (path, int) — артикул товара на Wildberries

**Заголовки:**
- `X-TG-Data` (optional) — данные инициализации Telegram Web App

**Ответ (200 OK):**
```json
{
    "id": 12345678,
    "name": "Название товара",
    "brand": "Бренд",
    "prices": {
        "wallet_purple": 1500,
        "standard_black": 1800,
        "base_crossed": 2000
    },
    "metrics": {
        "wallet_benefit": 300,
        "total_discount_percent": 25.0,
        "is_favorable": false
    },
    "status": "success",
    "attempts": 1
}
```

**Ошибки:**
- `401 Unauthorized` — неверные данные аутентификации (если включено)
- `500 Internal Server Error` — ошибка парсинга или обработки данных

---

## Дополнительные файлы и директории

### `proxy_ext/`
Директория для хранения временных файлов расширений браузера:
- `proxy_auth_plugin.zip` — расширение для авторизации прокси

### `node_modules/`
Директория зависимостей Node.js (автоматически генерируется)

### `venv/`
Виртуальное окружение Python (не должно попадать в репозиторий)

### `__pycache__/`
Кеш скомпилированных Python файлов (автоматически генерируется)

---

## Примечания

1. Проект использует Selenium для парсинга, что делает его зависимым от структуры HTML страницы Wildberries
2. Аутентификация через Telegram в настоящее время отключена (закомментирована в коде)
3. Прокси настройки обязательны для корректной работы парсера
4. Проект оптимизирован для работы в Telegram Web App, но может использоваться и как обычное веб-приложение
5. Требуется постоянное поддержание актуальности CSS селекторов при изменении структуры сайта Wildberries

